<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Plants</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/resources/css/includes/my plants.css">
</head>
<body>
    <div id="blurBox" style=""></div>
    <div id="infoAndEditBox">

        <select id="rate" onchange="reloadData()">
            <option value="h">Hourly</option>
            <option value="d">Daily</option>
            <option value="w">Weekly</option>
            <option value="m">Monthly</option>
            <option value="y">Yearly</option>
        </select>

        <input type="date" id="dateFrom" onchange="reloadData()">
        <input type="date" id="dateTo" onchange="reloadData()">

        <div style="" id="chartBox">
            <canvas id="Chart" style="width:100%; height:100%;"></canvas>
        </div>

    </div>
    <div id="plants">

    </div>
    <script>

        $(window).resize(function () {
            if(document.documentElement.clientWidth <= 699) {
                $("body").height(document.documentElement.clientHeight * 414 / document.documentElement.clientWidth);
                $("body").css({"transform": "scale(" +  document.documentElement.clientWidth / 414 +  ")", "left": (document.documentElement.clientWidth - 414) / 2 + "px", "top": ( $("body").height() * document.documentElement.clientWidth / 414 - $("body").height() ) / 2 + "px"});
            } else {
                let zoomFactor = (document.documentElement.clientWidth / 1638 * 100);
                document.body.style.zoom = zoomFactor + "%";            }
        });

        $(document).ready(function () {
            if(document.documentElement.clientWidth <= 699) {
                $("body").height(document.documentElement.clientHeight * 414 / document.documentElement.clientWidth);
                $("body").css({"transform": "scale(" +  document.documentElement.clientWidth / 414 +  ")", "left": (document.documentElement.clientWidth - 414) / 2 + "px", "top": ( $("body").height() * document.documentElement.clientWidth / 414 - $("body").height() ) / 2 + "px"});
            } else {
                let zoomFactor = (document.documentElement.clientWidth / 1638 * 100);
                document.body.style.zoom = zoomFactor + "%";
            }
        });

        $.get("/ajax/listSensors.php", function (data) {
            console.log(JSON.parse(data).sensorList);

            let jsonData = JSON.parse(data).sensorList;

            for (var i = 0; i < jsonData.length; i++ ) {

                let plantName = jsonData[i].name;
                let plantID = jsonData[i].id;

                $.getJSON("/ajax/getPlantTelemetry.php?latest=true&sensorID=" + jsonData[i].id, function (data) {

                    console.log(data);

                    if(data["plantTelemetry"] != undefined) {

                        $("#plants").append(
                            "<div>\n" +
                            "            <h1>" + plantName + "</h1>\n" +
                            "            <p>" + plantID + "</p>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/waterDrop.png\" alt=\"waterDrop\" class=\"waterDrop\">\n" +
                            "            <div class=\"moisture\">\n" +
                            "                <span style=\"width: " + data["plantTelemetry"].moisture + "%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/sun.png\" alt=\"sun\" class=\"sun\">\n" +
                            "            <div class=\"light\">\n" +
                            "                <span style=\"width: " + data["plantTelemetry"].light + "%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/waterDropMoisture.png\" alt=\"waterDropMoisture\" class=\"waterDropMoisture\">\n" +
                            "            <div class=\"humidity\">\n" +
                            "                <span style=\"width: " + data["plantTelemetry"].humidity + "%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/temperature.png\" alt=\"temperatureIcon\" class=\"temperatureIcon\">\n" +
                            "            <div class=\"temperature\">\n" +
                            "                <span style=\"width: " + (100 - data["plantTelemetry"].temperature) + "%;\"></span>\n" +
                            "            </div>\n" +
                            "            <button onclick='showInfo(\"" + plantID + "\")'>More Info</button>\n" +
                            "        </div>"
                        );
                    } else {
                        $("#plants").append(
                            "<div>\n" +
                            "            <h1>" + plantName + "</h1>\n" +
                            "            <p>" + plantID + "</p>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/waterDrop.png\" alt=\"waterDrop\" class=\"waterDrop\">\n" +
                            "            <div class=\"moisture\">\n" +
                            "                <span style=\"width: 0%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/sun.png\" alt=\"sun\" class=\"sun\">\n" +
                            "            <div class=\"light\">\n" +
                            "                <span style=\"width: 0%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/waterDropMoisture.png\" alt=\"waterDropMoisture\" class=\"waterDropMoisture\">\n" +
                            "            <div class=\"humidity\">\n" +
                            "                <span style=\"width: 0%;\"></span>\n" +
                            "            </div>\n" +
                            "            <img src=\"/resources/img/my%20plants.html/temperature.png\" alt=\"temperatureIcon\" class=\"temperatureIcon\">\n" +
                            "            <div class=\"temperature\">\n" +
                            "                <span style=\"width: 100%;\"></span>\n" +
                            "            </div>\n" +
                            "            <button>More Info</button>\n" +
                            "        </div>"
                        );
                    }
                })
            }

        });


        function showInfo( id ) {

            $("#dateFrom").attr("onchange", "reloadData('" + id + "')");
            $("#dateTo").attr("onchange", "reloadData('" + id + "')");
            $("#rate").attr("onchange", "reloadData('" + id + "')");

            var dateTime = new Date().toJSON().slice(0,10).replace(/-/g,'/');

            var today = new Date()
            var tomorrow = new Date(today)
            tomorrow.setDate(tomorrow.getDate() + 1)

            $("#dateFrom").val(today.toISOString().substr(0, 10));
            $("#dateTo").val(tomorrow.toISOString().substr(0, 10));

            $("#blurBox").show();
            $("#infoAndEditBox").show();

            $.getJSON("/ajax/getPlantTelemetry.php?sensorID=" + id + "&dateFrom=" + (new Date(dateTime).getTime()) / 1000 + "&dateTo=" + ((new Date(dateTime).getTime()) / 1000 + 86400) + "&latest=false&intervalRate=h", function (data) {
                console.log(data[0]);

                var lightData = [];
                var moistureData = [];
                var humidityData = [];
                var temperatureData = [];
                var labels = [];

                for (var i = 0; i < data[0].length; i++) {

                    lightData.push(data[0][i][2]);
                    moistureData.push(data[0][i][3]);
                    humidityData.push(data[0][i][0]);
                    temperatureData.push(data[0][i][1]);
                    labels.push(i);

                }

                var ctx = document.getElementById('Chart').getContext('2d');
                var chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Light',
                                borderColor: 'rgb(255, 216, 0)',
                                backgroundColor: 'rgb(255, 216, 0)',
                                data: lightData,
                                fill: false
                            },
                            {
                                label: 'Moisture',
                                borderColor: 'rgb(0, 147, 255)',
                                backgroundColor: 'rgb(0, 147, 255)',
                                data: moistureData,
                                fill: false
                            },
                            {
                                label: 'Humidity',
                                borderColor: 'rgb(0, 196, 255)',
                                backgroundColor: 'rgb(0, 196, 255)',
                                data: humidityData,
                                fill: false
                            },
                            {
                                label: 'Temperature',
                                borderColor: 'rgb(255, 0, 0)',
                                backgroundColor: 'rgb(255, 0, 0)',
                                data: temperatureData,
                                fill: false
                            }
                        ]
                    },

                    // Configuration options go here
                    options: {
                        scales: {
                            yAxes: [{
                                position: 'right',
                                stacked: false
                            }],
                            xAxes: [{
                                ticks: {}
                            }]
                        },
                        animation: {
                            duration: 0
                        }
                    }
                });

            });
        }

        function reloadData( id ) {

            $.getJSON("/ajax/getPlantTelemetry.php?sensorID=" + id + "&dateFrom=" + (new Date($("#dateFrom").val()).getTime()) / 1000 + "&dateTo=" + ((new Date($("#dateTo").val()).getTime()) / 1000 + 86400) + "&latest=false&intervalRate=" + $("#rate").val(), function (data) {
                console.log(data[0]);

                var lightData = [];
                var moistureData = [];
                var humidityData = [];
                var temperatureData = [];
                var labels = [];

                for (var i = 0; i < data[0].length; i++) {

                    lightData.push(data[0][i][2]);
                    moistureData.push(data[0][i][3]);
                    humidityData.push(data[0][i][0]);
                    temperatureData.push(data[0][i][1]);
                    labels.push(i);

                }

                $("#chartBox").html('<canvas id="Chart" style="width:100%; height:100%;"></canvas>');

                var ctx = document.getElementById('Chart').getContext('2d');
                var chart = new Chart(ctx, {
                    // The type of chart we want to create
                    type: 'line',

                    // The data for our dataset
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Light',
                                borderColor: 'rgb(255, 216, 0)',
                                backgroundColor: 'rgb(255, 216, 0)',
                                data: lightData,
                                fill: false
                            },
                            {
                                label: 'Moisture',
                                borderColor: 'rgb(0, 147, 255)',
                                backgroundColor: 'rgb(0, 147, 255)',
                                data: moistureData,
                                fill: false
                            },
                            {
                                label: 'Humidity',
                                borderColor: 'rgb(0, 196, 255)',
                                backgroundColor: 'rgb(0, 196, 255)',
                                data: humidityData,
                                fill: false
                            },
                            {
                                label: 'Temperature',
                                borderColor: 'rgb(255, 0, 0)',
                                backgroundColor: 'rgb(255, 0, 0)',
                                data: temperatureData,
                                fill: false
                            }
                        ]
                    },

                    // Configuration options go here
                    options: {
                        scales: {
                            yAxes: [{
                                position: 'right',
                                stacked: false
                            }],
                            xAxes: [{
                                ticks: {}
                            }]
                        },
                        animation: {
                            duration: 0
                        }
                    }
                });

            });

        }

    </script>
</body>
</html>